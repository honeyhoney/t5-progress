<!DOCTYPE html>
<html lang="en">

<head>
    <title>Visualisation of Tier 5 Progress (SSC)</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.css" />
    <style>
        #bar .x.axis text {
            text-anchor: end !important;
            transform: rotate(-30deg);
        }

        #pie text.pie-slice {
            fill: black;
        }
    </style>
</head>

<body>
    <div class="container">
        <section class="header">
            <h2>Tier 5/Serpentshrine Cavern Progress (Hellfire)</h2>
        </section>

        <div class="row">
            <h5>What is this?</h5>
            <p>This is a small visualisation built using <a href="https://github.com/dc-js/dc.js">dc.js</a> and serves to display the progess made by guilds in Serpentshrine Cavern realm during the first week of Tier 5 being released. You can click on the
                bars or pie chart segments to filter the data by guild and/or boss.</p>
        </div>

        <div class="row">
            <div class="nine columns">
                <div id="bar">
                    <h5>Boss Kill Count by Guild</h5></div>
            </div>
            <div class="three columns">
                <div id="pie">
                    <h5>Distribution of kills by boss<h5></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.js"></script>

    <script type="text/javascript">
        // Debug function
        function print_filter(filter) {
            var f = eval(filter);
            if (typeof(f.length) != "undefined") {} else {}
            if (typeof(f.top) != "undefined") {
                f = f.top(Infinity);
            } else {}
            if (typeof(f.dimension) != "undefined") {
                f = f.dimension(function(d) {
                    return "";
                }).top(Infinity);
            } else {}
            console.log(filter + "(" + f.length + ") = " + JSON.stringify(f).replace("[", "[\n\t").replace(/}\,/g, "},\n\t").replace("]", "\n]"));
        }

        var bar = dc.barChart("#bar");
        var pie = dc.pieChart("#pie");
        d3.csv('data.csv', function(data) {


            data.forEach(function(d) {
                var arr = d.boss.split(":");
                d.boss = arr[1] >= 3 ? arr[0] + ":1" : arr[0] + ":0";
            });

            var ndx = crossfilter(data);
            var guildDimension = ndx.dimension(function(d) {
                return d.guild;
            });
            var kills = guildDimension.group().reduceSum(function(d) {
                return d.boss.split(":")[1];
            });
            var bossDimension = ndx.dimension(function(d) {
                return d.boss.split(":")[0]
            });
            var bossGroup = bossDimension.group().reduceSum(function(d) {
                return d.boss.split(":")[1];
            });

            bar
                .width(700)
                .height(350)
                .margins({
                    left: 40,
                    top: 30,
                    bottom: 60,
                    right: 0
                })
                .brushOn(false)
                .x(d3.scale.ordinal().domain(data.map(function(d) {
                    return d.guild;
                })))
                .xUnits(dc.units.ordinal)
                .yAxisLabel("Boss Kill Count")
                .xAxisLabel("Guild")
                .dimension(guildDimension)
                .group(kills);
            bar.yAxis().ticks(6);
            bar.render();

            pie
                .width(200)
                .height(200)
                .dimension(bossDimension)
                .group(bossGroup);
            pie.render();
        });
    </script>
</body>

</html>
